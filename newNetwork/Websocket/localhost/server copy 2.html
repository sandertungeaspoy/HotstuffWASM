<html>
	<head>
		<meta charset="utf-8"/>
		<script src="wasm_exec.js"></script>
		<script>
            var read = new WebAssembly.Memory({initial:10, maximum:100});
            var write = new WebAssembly.Memory({initial:10, maximum:100});
            var readMsg = new String(read.buffer)
			const go = new Go();
			WebAssembly.instantiateStreaming(fetch("mem.wasm"), go.importObject, { js: { mem: read , mem: write} }).then(
				result => {
          			mod = result.module;
          			inst = result.instance;
          			document.getElementById("runButton").disabled = false;
        		}
      		);

      		async function run() {
        		await go.run(inst);
        		inst = await WebAssembly.instantiate(mod, go.importObject); // reset instance
      		}
            
            
            
		</script>
	</head>
	<body>
		<h1>HotStuff WASM Server</h1>
			Self-ID:<input type="number" id="self-id" step="1" min="1" max="4" name="Server ID" value="1">
			
			<button onClick="GetSelfID('self-id'); startWebRTC();" id="idButton">Assign</button>
			Chat:<input type="text" id="text" name="charbox" value="Test">
            <p id="textbox">This is a test</p>
			<button onClick="passUint8ArrayToGo();" id="SendButton">Send</button>
            <button onClick="setUint8ArrayInGo();" id="RecvButton">Receive</button>
			<button onClick="run();" id="runButton" disabled>Run</button>
            <button onClick="readMessages();" id="readButton" >ReadMsg</button>
	</body>
    <script src="https://webrtc.github.io/adapter/adapter-latest.js"></script>
    <script>

        var server = { urls: "stun:stun.l.google.com:19302" };

        var dc, pc = new RTCPeerConnection({ iceServers: [server] });
        pc.ondatachannel = e => dcInit(dc = e.channel);
        pc.oniceconnectionstatechange = e => console.log(pc.iceConnectionState);

        var dc2, pc2 = new RTCPeerConnection({ iceServers: [server] });
        pc2.ondatachannel = e2 => dcInit(dc2 = e2.channel);
        pc2.oniceconnectionstatechange = e2 => console.log(pc2.iceConnectionState);

        var dc3, pc3 = new RTCPeerConnection({ iceServers: [server] });
        pc3.ondatachannel = e3 => dcInit(dc3 = e3.channel);
        pc3.oniceconnectionstatechange = e3 => console.log(pc3.iceConnectionState);

        var offer = "";
        var answer = "";
        var welcomeMsg = "";

        function dcInit() {
            dc.onopen = () => sendData(welcomeMsg);
            dc.onmessage = e => console.log(e.data);
        }

        function createOffer() {
            dcInit(dc = pc.createDataChannel("chat"));
            pc.createOffer().then(d => pc.setLocalDescription(d));
            pc.onicecandidate = e => {
                if (e.candidate) return;
                offer = pc.localDescription.sdp;
                console.log(offer);
            };
            return true;
        };


        function createAnswer() {
            if (pc.signalingState != "stable") return;
            var desc = new RTCSessionDescription({ type:"offer", sdp:offer });
            pc.setRemoteDescription(desc)
                .then(() => pc.createAnswer()).then(d => pc.setLocalDescription(d));
        };


        function startChannel() {
            console.log("Trying to start channel")
            if (pc.signalingState != "have-local-offer") return;
            var desc = new RTCSessionDescription({ type:"answer", sdp:answer });
            pc.setRemoteDescription(desc);
        };

        function sendData(data) {
            dc.send(data)
        };

        function startWebRTC() {
            var id = document.getElementById("self-id").value;
            if (id == 1) {
                welcomeMsg = "Hello from Server 1"
                createOffer();
                var ws = new WebSocket("ws://localhost:13371");
                ws.onopen = function() {
                    offer += "&"
                    ws.send(offer);
                    console.log(offer);
                    ws.send("setup:recvAnswer\n&");
                 };
                
                ws.onmessage = function (evt) {
                    answer = evt.data;
                    console.log(answer);
                    startChannel();
                }
            } else {
                // Wait for offer
                welcomeMsg = "Hello from Server 2"
                var ws = new WebSocket("ws://localhost:13372");
                ws.onopen = function() {
                    ws.send("setup:recvOffer\n&");
                 };
                ws.onmessage = function (evt) { 
                    offer = evt.data;
                    console.log(offer);
                    createAnswer();
                    
                    pc.onicecandidate = e => {
                        if (e.candidate) return;
                        answer = pc.localDescription.sdp;
                        console.log(answer);
                        answer += "&"; 
                        ws.send(answer);
                    };
                };
            }
        };


        function setText() {
            document.getElementById("textbox").innerHTML = readMsg;
        }
          
        function passUint8ArrayToGo(){

            array_to_pass = new Uint8Array([0, 9, 21, 32])
        
            console.log(array_to_pass)
        
            PassUint8ArrayToGo(array_to_pass)
        }
        
        function setUint8ArrayInGo(){

        array_to_set = new Uint8Array()
    
        SetUint8ArrayInGo(array_to_set)
    
        console.log(array_to_set)
    
        array_to_set = new Uint8Array(4)
    
        SetUint8ArrayInGo(array_to_set)
    
        console.log(array_to_set)
        }
        

    </script>
</html>