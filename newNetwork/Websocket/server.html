<html>
	<head>
		<meta charset="utf-8"/>
        <!-- https://pixabay.com/vectors/flame-torch-heat-warmth-warm-296977/ -->
        <link rel="shortcut icon" href="favicon.ico" type="image/x-icon">  
		<script src="script/wasm_exec.js"></script>
        <script src="https://canvasjs.com/assets/script/canvasjs.min.js"></script>
		<script>
            var read = new WebAssembly.Memory({initial:10, maximum:100});
            var write = new WebAssembly.Memory({initial:10, maximum:100});
            var readMsg = new String(read.buffer)
			const go = new Go();
			WebAssembly.instantiateStreaming(fetch("server.wasm"), go.importObject, { js: { mem: read , mem: write} }).then(
				result => {
          			mod = result.module;
          			inst = result.instance;
        		}
                
      		);

      		async function run() {
                document.getElementById("runButton").disabled = true;
        		await go.run(inst);
        		inst = await WebAssembly.instantiate(mod, go.importObject); // reset instance
                
      		}
            
            
            
		</script>
        <!-- <script src="https://webrtc.github.io/adapter/adapter-latest.js"></script>
        <script src="script/server1.js"></script>
        <script src="script/server2.js"></script>
        <script src="script/server3.js"></script> -->
        <!-- <script>
            var id;
            function startSRV(){
                startWebRTC();
                startWebRTC2();
                startWebRTC3();
                id = document.getElementById("self-id").value;
                document.getElementById("self-id").disabled = false;
                document.getElementById("idButton").disabled = false;
                document.getElementById("id1").disabled = true;
                document.getElementById("id2").disabled = true;
                document.getElementById("id3").disabled = true;
                document.getElementById("id4").disabled = true;
            }
        </script> -->
        
	</head>
	<body>
                
		<h1>HotStuff WASM Server</h1>
			Self-ID:<input type="text" id="self-id" name="Server ID" value="1" disabled=true readonly>
            Block amount:<input type="text" id="blocks" name="blocks" value="1">
			
			<button onClick="GetSelfID('self-id'); GetBlockNumber('blocks'); this.disabled = true;" id="idButton">Assign</button>

            <button onClick="document.getElementById('self-id').value = 1;" id="id1">Start Srv 1</button>
            <button onClick="document.getElementById('self-id').value = 2;" id="id2">Start Srv 2</button>
            <button onClick="document.getElementById('self-id').value = 3;" id="id3">Start Srv 3</button>
            <button onClick="document.getElementById('self-id').value = 4;" id="id4">Start Srv 4</button>

			<!-- Chat:<input type="text" id="text" name="charbox" value="Test"> -->
            <p id="textbox">This is a test</p>
			<!-- <button onClick="passUint8ArrayToGo();" id="SendButton">Send</button> -->
            <button onClick="assignHandler();" id="RecvButton">Assign</button>
			<button onClick="run();" id="runButton">Run</button>
            <button onClick="StartAgain();" id="startButton" >Start Again</button>
            <button onclick="restartWebRTCHandler();" id="restartButton">Restart WebRTC handler</button>
            Command:<input type="text" id="command" name="cmd">
            <button onClick="GetCommand('command');">Send command</button>

            <a href="hash.txt" download>Download MD5 Checksums</a>
	</body>
    <link rel="stylesheet" href="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css" integrity="sha384-q94+BZtLrkL1/ohfjR8c6L+A6qzNH9R2hBLwyoAfu3i/WCvQjzL2RQJ3uNHDISdU" crossorigin="anonymous">
    <script src="script/jquery-3.4.1.min.js"></script>
    <script src="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js" integrity="sha384-8Vi8VHwn3vjQ9eUHUxex3JSN/NFqUg3QbPyX8kWyb93+8AC/pPWTzj+nHtbC5bxD" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.2/chess.js" integrity="sha384-s3XgLpvmHyscVpijnseAmye819Ee3yaGa8NxstkJVyA6nuDFjt59u1QvuEl/mecz" crossorigin="anonymous"></script>
    <script>
        intervalClearConsole = window.setInterval(function(){
            console.clear();
          }, 10000);

        function restartWebRTCHandler() {
            var wsRestart = new WebSocket("ws://127.0.0.1:13372");
            wsRestart.onopen = function() {
                wsRestart.send("setup:purgeDatabase\n&0%");
                console.log("Web RTC Handler restarted!");
            };
        };


        function setText() {
            document.getElementById("textbox").innerHTML = readMsg;
        }
          
        function passMsgToGo(val){

            var array_to_pass = new Uint8Array(val);
        
            console.log(array_to_pass)
        
            PassUint8ArrayToGo(array_to_pass)
        }
        

        function readSendMsgs() {
            var arraySize = new Uint8Array(10);
            var moreMsg = new Uint8Array(1);
            GetArraySize(arraySize, moreMsg);
            var size = new TextDecoder("utf-8").decode(arraySize);
            var sizeint = parseInt(size);
            var msgs = new TextDecoder("utf-8").decode(moreMsg);
            var msgsint = parseInt(msgs);
    
            var msg = new Uint8Array(sizeint);
            SetUint8ArrayInGo(msg);
            if (msg.length > 0) {
                if (id == 1){
                    sendData(msg);
                    sendData2(msg);
                    sendData3(msg);
                } else if (id == 2) {
                    sendData(msg);
                } else if (id == 3) {
                    sendData2(msg);
                } else if (id == 4) {
                    sendData3(msg);
                }
            };
            if (msgsint > 0) {
                readSendMsgs();
            }
        };
    

    var intervalReadSendWASM;

    var trafficStarted = false;
    function startTraffic() {
        intervalReadSendWASM = window.setInterval(function(){
            readSendMsgs();
          }, 50);
    };

    function assignHandler() {
        if (id == 1){
            dc.onmessage = e => {if (!trafficStarted) {startTraffic(); trafficStarted = true;}; console.log(e.data); passMsgToGo(e.data);}
            dc2.onmessage = e => {if (!trafficStarted) {startTraffic(); trafficStarted = true;}; console.log(e.data); passMsgToGo(e.data);}
            dc3.onmessage = e => {if (!trafficStarted) {startTraffic(); trafficStarted = true;}; console.log(e.data); passMsgToGo(e.data);}
        } else if (id == 2) {
            dc.onmessage = e => {if (!trafficStarted) {startTraffic(); trafficStarted = true;}; console.log(e.data); passMsgToGo(e.data);}
        } else if (id == 3) {
            dc2.onmessage = e => {if (!trafficStarted) {startTraffic(); trafficStarted = true;}; console.log(e.data); passMsgToGo(e.data);}
        } else if (id == 4) {
            dc3.onmessage = e => {if (!trafficStarted) {startTraffic(); trafficStarted = true;}; console.log(e.data); passMsgToGo(e.data);}
        }
    };


    </script>
</html>