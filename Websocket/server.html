<html>
	<head>
		<meta charset="utf-8"/>
		<script src="script/wasm_exec.js"></script>
		<script>
            var read = new WebAssembly.Memory({initial:10, maximum:100});
            var write = new WebAssembly.Memory({initial:10, maximum:100});
            var readMsg = new String(read.buffer)
			const go = new Go();
			WebAssembly.instantiateStreaming(fetch("mem.wasm"), go.importObject, { js: { mem: read , mem: write} }).then(
				result => {
          			mod = result.module;
          			inst = result.instance;
        		}
                
      		);

      		async function run() {
                document.getElementById("runButton").disabled = true;
                assignHandler();
        		await go.run(inst);
        		inst = await WebAssembly.instantiate(mod, go.importObject); // reset instance
                
      		}
            
            
            
		</script>
        <script src="https://webrtc.github.io/adapter/adapter-latest.js"></script>
        <script src="script/server1.js"></script>
        <script src="script/server2.js"></script>
        <script src="script/server3.js"></script>
        <script>
            var id;
            function startSRV(){
                startWebRTC();
                startWebRTC2();
                startWebRTC3();
                id = document.getElementById("self-id").value;
                document.getElementById("self-id").disabled = false;
                document.getElementById("idButton").disabled = false;
                document.getElementById("id1").disabled = true;
                document.getElementById("id2").disabled = true;
                document.getElementById("id3").disabled = true;
                document.getElementById("id4").disabled = true;
            }
        </script>
        
	</head>
	<body>
                
		<h1>HotStuff WASM Server</h1>
			Self-ID:<input type="text" id="self-id" name="Server ID" value="1" disabled=true readonly>
			
			<button onClick="GetSelfID('self-id'); this.disabled = true;" disabled=true id="idButton">Assign</button>

            <button onClick="document.getElementById('self-id').value = 1; startSRV();" id="id1">Start Srv 1</button>
            <button onClick="document.getElementById('self-id').value = 2; startSRV();" id="id2">Start Srv 2</button>
            <button onClick="document.getElementById('self-id').value = 3; startSRV();" id="id3">Start Srv 3</button>
            <button onClick="document.getElementById('self-id').value = 4; startSRV();" id="id4">Start Srv 4</button>

			<!-- Chat:<input type="text" id="text" name="charbox" value="Test"> -->
            <p id="textbox">This is a test</p>
			<!-- <button onClick="passUint8ArrayToGo();" id="SendButton">Send</button> -->
            <button onClick="assignHandler();" id="RecvButton">Assign</button>
			<button onClick="run();" id="runButton">Run</button>
            <button onClick="startTraffic();" id="startButton" >Start Traffic</button>
            <button onclick="restartWebRTCHandler();" id="restartButton">Restart WebRTC handler</button>
	</body>

    <script>

        function restartWebRTCHandler() {
            var wsRestart = new WebSocket("ws://localhost:13371");
            wsRestart.onopen = function() {
                console.log("Web RTC Handler restarted!");
            };
        };


        function setText() {
            document.getElementById("textbox").innerHTML = readMsg;
        }
          
        function passMsgToGo(val){

            var array_to_pass = new Uint8Array(val);
        
            console.log(array_to_pass)
        
            PassUint8ArrayToGo(array_to_pass)
        }
        

    function readSendMsgs() {
        var arraySize = new Uint8Array(10);
        GetArraySize(arraySize);
        var size = new TextDecoder("utf-8").decode(arraySize);
        var sizeint = parseInt(size);

        var msg = new Uint8Array(sizeint);
        SetUint8ArrayInGo(msg);
        if (msg.length > 0) {
            if (id == 1){
                sendData(msg);
                sendData2(msg);
                sendData3(msg);
            } else if (id == 2) {
                sendData(msg);
            } else if (id == 3) {
                sendData2(msg);
            } else if (id == 4) {
                sendData3(msg);
            }
        };
    };

    var intervalReadSendWASM;

    var trafficStarted = false;
    function startTraffic() {
        intervalReadSendWASM = window.setInterval(function(){
            readSendMsgs();
          }, 50);
    };

    function assignHandler() {
        if (id == 1){
            dc.onmessage = e => {if (!trafficStarted) {startTraffic(); trafficStarted = true;}; passMsgToGo(e.data);}
            dc2.onmessage = e => {if (!trafficStarted) {startTraffic(); trafficStarted = true;}; passMsgToGo(e.data);}
            dc3.onmessage = e => {if (!trafficStarted) {startTraffic(); trafficStarted = true;}; passMsgToGo(e.data);}
        } else if (id == 2) {
            dc.onmessage = e => {if (!trafficStarted) {startTraffic(); trafficStarted = true;}; passMsgToGo(e.data);}
        } else if (id == 3) {
            dc2.onmessage = e => {if (!trafficStarted) {startTraffic(); trafficStarted = true;}; passMsgToGo(e.data);}
        } else if (id == 4) {
            dc3.onmessage = e => {if (!trafficStarted) {startTraffic(); trafficStarted = true;}; passMsgToGo(e.data);}
        }
    };


    </script>
</html>